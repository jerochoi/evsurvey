<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incheon Building Map (Compound)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        #layout {
            display: flex;
            height: 100%;
            flex-direction: row-reverse;
        }

        #sidebar {
            width: 320px;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }

        #sidebar-header {
            padding: 20px;
            background: #8e44ad;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
        }

        #filter-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 25px;
        }

        .filter-title {
            font-size: 14px;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            cursor: pointer;
        }

        .checkbox-item input {
            margin-right: 10px;
            cursor: pointer;
            accent-color: #8e44ad;
        }

        .checkbox-item:hover {
            background-color: #f9f9f9;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 6px;
            border-radius: 2px;
        }

        #status-bar {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            font-size: 13px;
            text-align: center;
            color: #555;
        }

        #map {
            flex: 1;
            height: 100%;
            background: #f0f2f5;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
    </style>
</head>

<body>

    <div id="layout">
        <div id="sidebar">
            <div id="sidebar-header">인천 건물 통합 (일반+집합)</div>

            <div id="filter-container">
                <!-- Region Select -->
                <div class="filter-section">
                    <div class="filter-title">시군구 선택</div>
                    <select id="sigungu-select">
                        <option value="">시군구 선택...</option>
                    </select>
                </div>

                <div class="filter-section">
                    <div class="filter-title">충전소 반경 표시 (ME)</div>
                    <div class="checkbox-group">
                        <label class="checkbox-item"><input type="radio" name="radius" value="0"> 없음</label>
                        <label class="checkbox-item"><input type="radio" name="radius" value="500" checked> 반경
                            500m</label>
                        <label class="checkbox-item"><input type="radio" name="radius" value="1000"> 반경 1km</label>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title">건물용도분류 (색상 구분)</div>
                    <div class="checkbox-group" id="class-filters">
                        <label class="checkbox-item"><input type="checkbox" value="주거용" checked> <span
                                class="legend-color" style="background:#F1C40F;"></span>주거용</label>
                        <label class="checkbox-item"><input type="checkbox" value="상업용" checked> <span
                                class="legend-color" style="background:#E74C3C;"></span>상업용</label>
                        <label class="checkbox-item"><input type="checkbox" value="공업용" checked> <span
                                class="legend-color" style="background:#9B59B6;"></span>공업용</label>
                        <label class="checkbox-item"><input type="checkbox" value="공공용" checked> <span
                                class="legend-color" style="background:#3498db;"></span>공공용</label>
                        <label class="checkbox-item"><input type="checkbox" value="문교사회용" checked> <span
                                class="legend-color" style="background:#2ECC71;"></span>문교사회용</label>
                        <label class="checkbox-item"><input type="checkbox" value="농수산용" checked> <span
                                class="legend-color" style="background:#E67E22;"></span>농수산용</label>
                        <label class="checkbox-item"><input type="checkbox" value="기타" checked> <span
                                class="legend-color" style="background:#95A5A6;"></span>기타</label>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="filter-title" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>주요용도코드 (명칭)</span>
                        <button onclick="toggleAllUsages()"
                            style="font-size:10px; padding:2px 6px; cursor:pointer;">전체선택/해제</button>
                    </div>
                    <div class="checkbox-group" id="usage-filters">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div id="status-bar">
                총 <b id="total-count">0</b>개 중 <b id="visible-count">0</b>개 표시
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Pako for Gzip inflation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="data/d162_164_meta.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map').setView([37.4563, 126.7052], 12);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const COLORS = {
                "주거용": "#F1C40F", "상업용": "#E74C3C", "공업용": "#9B59B6",
                "공공용": "#3498db", "문교사회용": "#2ECC71", "농수산용": "#E67E22", "기타": "#95A5A6"
            };

            const SIGUNGU_MAP = {
                "28110": { name: "중구", file: "23010_inline.geojson" },
                "28140": { name: "동구", file: "23020_inline.geojson" },
                "28177": { name: "미추홀구", file: "23030_inline.geojson" },
                "28185": { name: "연수구", file: "23040_inline.geojson" },
                "28200": { name: "남동구", file: "23050_inline.geojson" },
                "28237": { name: "부평구", file: "23060_inline.geojson" },
                "28245": { name: "계양구", file: "23070_inline.geojson" },
                "28260": { name: "서구", file: "23080_inline.geojson" },
                "28710": { name: "강화군", file: "23310_inline.geojson" },
                "28720": { name: "옹진군", file: "23320_inline.geojson" }
            };

            const select = document.getElementById('sigungu-select');
            const meta = window.d162_164Meta || [];

            meta.forEach(m => {
                const info = SIGUNGU_MAP[m.code];
                if (info) {
                    const opt = document.createElement('option');
                    opt.value = m.code;
                    opt.innerText = `${info.name} (${m.count}건)`;
                    select.appendChild(opt);
                }
            });

            // Layer storage
            var layers = {
                buildings: null,
                boundary: null,
                stations: L.layerGroup(),
                radius: L.layerGroup()
            };
            layers.stations.addTo(map);
            layers.radius.addTo(map);

            // Load Charging Stations
            fetch('stat_me.json')
                .then(res => res.json())
                .then(stations => {
                    const icon = L.divIcon({
                        className: 'station-icon',
                        html: '<div style="background:blue; width:10px; height:10px; border-radius:50%; border:2px solid white;"></div>',
                        iconSize: [14, 14]
                    });

                    stations.forEach(s => {
                        const marker = L.marker([s.lat, s.lng], { icon: icon }).bindPopup(`
                            <div style="font-weight:bold;">${s.statNm}</div>
                            <div style="font-size:12px;">${s.addr || ""}</div>
                        `);
                        marker.stationData = s; // Attach data for radius usage
                        layers.stations.addLayer(marker);
                    });

                    // Trigger initial radius drawing if checked
                    const initialRadius = document.querySelector('input[name="radius"]:checked');
                    if (initialRadius) {
                        initialRadius.dispatchEvent(new Event('change'));
                    }
                })
                .catch(e => console.error("Stations load failed", e));

            // Initial Load for Seo-gu (28260)
            setTimeout(() => {
                select.value = "28260";
                // Force load data even if select option sync issues occur
                loadData("28260");
            }, 2000); // Delayed execution to ensure page stability

            // Radius Logic
            document.querySelectorAll('input[name="radius"]').forEach(radio => {
                radio.addEventListener('change', function (e) {
                    const r = parseInt(e.target.value);
                    layers.radius.clearLayers();

                    if (r > 0) {
                        layers.stations.eachLayer(marker => {
                            const circle = L.circle(marker.getLatLng(), {
                                radius: r,
                                color: 'blue',
                                weight: 1,
                                fillOpacity: 0.1,
                                interactive: false
                            });
                            layers.radius.addLayer(circle);
                        });
                    }
                });
            });

            const dataCache = {};

            select.addEventListener('change', function (e) {
                const code = e.target.value;
                if (code) loadData(code);
            });

            async function loadData(code) {
                const statusBar = document.getElementById('status-bar');
                if (statusBar) statusBar.innerText = "데이터 다운로드 및 압축 해제 중...";

                try {
                    let geojsonData = dataCache[code];

                    if (!geojsonData) {
                        const response = await fetch(`data/d162_164_${code}.json.gz`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                        const arrayBuffer = await response.arrayBuffer();

                        // Decompress using pako
                        const decompressed = pako.inflate(new Uint8Array(arrayBuffer), { to: 'string' });
                        geojsonData = JSON.parse(decompressed);

                        dataCache[code] = geojsonData; // Cache it
                    }

                    updateBuildingLayer(geojsonData);
                    updateFilters(geojsonData);

                    if (statusBar) statusBar.innerText = `로드 완료: ${geojsonData.features.length}개`;

                    // Force redraw after a short delay to ensure DOM updates
                    setTimeout(() => {
                        filterAndDraw();
                        // Special handling for Seogu (28260) zoom
                        if (code === "28260") {
                            map.setView([37.545, 126.676], 13); // Zoom into Seogu-office area
                        }
                    }, 100);

                    // Load Boundary (Optional)
                    const boundaryInfo = SIGUNGU_MAP[code];
                    if (boundaryInfo && boundaryInfo.file) {
                        fetch(`data/${boundaryInfo.file}`)
                            .then(res => res.json())
                            .then(boundaryGeoJSON => {
                                updateBoundaryLayer(boundaryGeoJSON);
                            })
                            .catch(err => console.log("Boundary load skipped"));
                    }

                } catch (e) {
                    console.error("Load failed", e);
                    if (statusBar) statusBar.innerText = "데이터 로딩 실패: " + e.message;
                }
            }

            function updateBuildingLayer(geojson) {
                if (layers.buildings) map.removeLayer(layers.buildings);

                window.currentGeoJson = geojson;
                const totalCount = document.getElementById('total-count');
                if (totalCount) totalCount.innerText = geojson.features.length;

                filterAndDraw();

                // Fit bounds automatically
                if (layers.buildings && layers.buildings.getBounds().isValid()) {
                    map.fitBounds(layers.buildings.getBounds());
                }
            }

            function updateBoundaryLayer(geojson) {
                if (layers.boundary) map.removeLayer(layers.boundary);

                layers.boundary = L.geoJSON(geojson, {
                    style: { color: '#000', weight: 2, fill: false, dashArray: '5, 5' }
                }).addTo(map);
            }

            function updateFilters(geojson) {
                const container = document.getElementById('usage-filters');
                container.innerHTML = '';

                const uniqueUsages = new Set();
                const usageCodeMap = {};

                geojson.features.forEach(f => {
                    const u = f.properties.usage_name;
                    if (u) {
                        uniqueUsages.add(u);
                        usageCodeMap[u] = f.properties.usage_code;
                    }
                });

                Array.from(uniqueUsages).sort().forEach(u => {
                    const label = document.createElement('label');
                    label.className = 'checkbox-item';
                    const code = usageCodeMap[u] ? `(${usageCodeMap[u]})` : "";
                    label.innerHTML = `<input type="checkbox" value="${u}" checked> <span>${u} <span style="font-size:0.8em; color:#999;">${code}</span></span>`;
                    container.appendChild(label);
                });
            }

            window.toggleAllUsages = function () {
                const cbs = document.querySelectorAll('#usage-filters input[type=checkbox]');
                const allChecked = Array.from(cbs).every(cb => cb.checked);
                cbs.forEach(cb => cb.checked = !allChecked);
                filterAndDraw();
            };

            function filterAndDraw() {
                if (!window.currentGeoJson) return;

                if (layers.buildings) map.removeLayer(layers.buildings);

                const checkedClasses = Array.from(document.querySelectorAll('#class-filters input:checked')).map(cb => cb.value);
                const checkedUsages = Array.from(document.querySelectorAll('#usage-filters input:checked')).map(cb => cb.value);

                const filtered = window.currentGeoJson.features.filter(f => {
                    const p = f.properties;
                    const c = p.class_name || "기타";
                    const u = p.usage_name || "미지정";
                    return checkedClasses.includes(c) && checkedUsages.includes(u);
                });

                const visibleCountLabel = document.getElementById('visible-count');
                if (visibleCountLabel) visibleCountLabel.innerText = filtered.length;

                layers.buildings = L.geoJSON({ type: "FeatureCollection", features: filtered }, {
                    style: function (f) {
                        return {
                            fillColor: COLORS[f.properties.class_name] || COLORS['기타'],
                            weight: 1, opacity: 1, color: 'white', fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function (f, l) {
                        const p = f.properties;
                        const c = COLORS[p.class_name] || COLORS['기타'];
                        l.bindPopup(`
                        <div style="background:${c}; color:#fff; padding:10px; font-weight:bold;">${p.name || "건물명 없음"}</div>
                        <div style="padding:10px; font-size:13px; line-height:1.6;">
                            <div><b>종류:</b> ${p.source_type === 'general' ? '일반건축물' : '집합건물'}</div>
                            <div><b>주소:</b> ${p.address}</div>
                            <div><b>용도:</b> ${p.usage_name}</div>
                            <div><b>분류:</b> ${p.class_name}</div>
                            <div><b>주차:</b> ${p.parking_count}</div>
                            <div><b>허가:</b> ${p.permit_date}</div>
                        </div>
                    `);
                        l.on('mouseover', function (e) { e.target.setStyle({ weight: 3, color: '#333' }); e.target.bringToFront(); });
                        l.on('mouseout', function (e) { layers.buildings.resetStyle(e.target); });
                    }
                }).addTo(map);
            }

            // Listener for filters
            document.getElementById('filter-container').addEventListener('change', function (e) {
                if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') filterAndDraw();
            });
        });
    </script>

</body>

</html>